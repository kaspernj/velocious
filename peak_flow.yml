before_install:
  - sudo mkdir -p /etc/apt/keyrings
  - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --no-tty --batch --yes --dearmor -o /etc/apt/keyrings/nodesource.gpg
  - echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_24.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list
  - sudo apt-get update
  - sudo apt-get install -y nodejs
before_script:
  - npm install
environment:
  NODE_ENV: test
services:
  mariadb:
    environment:
      MYSQL_USER: peakflow
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: velocious_test
    image: mariadb:latest
    expose:
      - 3306
    mem_limit: 4096m
    restart_policy: on-failure
  mssql:
    environment:
      ACCEPT_EULA: Y
      MSSQL_PID: Developer
      MSSQL_SA_PASSWORD: Super-Secret-Password
    image: mcr.microsoft.com/mssql/server:2022-latest
    expose:
      - 1433
    mem_limit: 4096m
    restart_policy: on-failure
  postgres:
    environment:
      POSTGRES_USER: peakflow
      POSTGRES_PASSWORD: password
      POSTGRES_DB: velocious_test
    image: postgres:17.6
    expose:
      - 5432
    mem_limit: 4096m
    restart_policy: on-failure
builds:
  build_1:
    name: MariaDB
    script:
      - cp spec/dummy/src/config/configuration.peakflow.mariadb.js spec/dummy/src/config/configuration.js
      - wait-for-it mariadb:3306
      - wait-for-it mssql:1433
      - cd spec/dummy && npx velocious db:create
      - npm test
  build_2:
    name: MS-SQL
    script:
      - cp spec/dummy/src/config/configuration.peakflow.mssql.js spec/dummy/src/config/configuration.js
      - wait-for-it mssql:1433
      - cd spec/dummy && npx velocious db:create
      - npm test
  build_3:
    name: PG-SQL
    script:
      - cp spec/dummy/src/config/configuration.peakflow.pgsql.js spec/dummy/src/config/configuration.js
      - wait-for-it mssql:1433
      - wait-for-it postgres:5432
      - cd spec/dummy && npx velocious db:create
      - npm test
  build_4:
    name: SQLite
    script:
      - cp spec/dummy/src/config/configuration.peakflow.sqlite.js spec/dummy/src/config/configuration.js
      - wait-for-it mssql:1433
      - cd spec/dummy && npx velocious db:create
      - npm test
