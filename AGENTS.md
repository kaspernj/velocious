## Purpose
This repo uses an automated “definition of done” for changes. Before declaring work complete, run the appropriate verification commands and fix any failures.

## Build output
`build/` contains compiled files generated by `npm run build`. Do not edit files under `build/` manually.

## Testing guidance
Prefer using the dummy app for tests instead of fake classes or stubbing.
Prefer functional tests over raw SQL assertions because SQL varies by database. Only assert SQL when validating a query parser, and normalize it to avoid quoting differences.
Document newly discovered behavior, constraints, edge cases, and integration caveats in the `docs/` folder as part of normal development flow.
After changing base model generator logic, run `npx velocious g:base-models` from `spec/dummy` so the generated base models stay in sync.
`spec/dummy/db/structure-default.sql` is a generated schema snapshot; don't edit it manually, and commit updates when migrations/tests change it.
Always add tests for new or changed behavior.
Websocket channel callbacks should use `configuration.ensureConnections(...)` so existing async-context DB connections are reused; reserve `configuration.withConnections(...)` for creating new async-context connections when you truly need a fresh context (e.g., concurrent work).
Prefer `awaitery`'s `timeout` helper over manual `Promise.race` timeouts when a simple hard timeout is needed.
When editing `CHANGELOG.md`, append entries without creating new version headings (agents don't control releases).
When adding or changing features, update `README.md` with the relevant usage and behavior details.
Name specs that should run in browser tests with the `.browser-spec.js` suffix so the browser test runner includes them.
Use spaces inside named imports (e.g. `import {foo, bar} from "..."`).

## Verification commands

### Targeted checks (preferred)
Run only the relevant, changed, or new linters and tests locally:
- Always run `npm run lint` after changing any files.
- Use `npm run typecheck` when changes affect types.
- Use `npx velocious test <path-or-example>` for focused specs.
- Prefer adding or updating tests and running only those.
- Keep indentation consistent with the surrounding code.

### Quick check (fast)
Run as needed while iterating:

1) Lint
   `npm run lint`

2) Typecheck
   `npm run typecheck`

### Normal check (full validation, slower)
Skip full local suites; Peakflow will run the full test matrix for all database types on PRs.

If any command fails:
- Read the error output, fix the underlying issue, and re-run the same command.
- Repeat until the command succeeds (or clearly explain why it cannot be made to pass).

## PR description formatting
When editing PRs via CLI, use actual newlines in the body. Avoid literal `\n` sequences in the final description.

## When to run which check
- **Tiny change (docs/comments/non-functional formatting):** you may skip checks.
- **Most code changes:** run **Quick check** at least once while iterating.
- **Before final completion / ready for review:** run **Normal check**.

## Making tests faster while iterating (focus mode)

When iterating on tests, you may temporarily focus a subset of tests to speed up feedback.
This repo supports a `focus` argument on `describe` / `it` blocks:

### Focus a `describe`
```js
describe("something", {focus: true}, () => {
  // ...
})
```

### Focus an `it`
```js
describe("something", () => {
  it("sample", {focus: true}, () => {
    // ...
  })
})
```

## Pull requests
Use the `gh` CLI to open GitHub pull requests when needed.
Do not push to GitHub unless explicitly asked.

## Branches and commits
When asked to create branches and commit changes, come up with fitting branch names and commit messages. Split commits into smaller commits for each distinct change.
